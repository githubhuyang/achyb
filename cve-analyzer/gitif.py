#!/usr/bin/env python
# -*- coding: utf-8 -*-

""" APIs for git diff analysis """

import os
from const import *


def checkout(commitid):
    ''' checkout a branch '''
    old_dir = os.getcwd()
    os.chdir(kernel_path)

    checkout_cmd = "git checkout -f " + commitid + "~1"
    os.system(checkout_cmd)

    os.chdir(old_dir)


def git_diff_by_link(link):
    ''' get diff from a link (for patchwork.ozlabs.org only) '''
    curl_cmd = "curl " + link + "raw/ > diff.txt"
    os.system(curl_cmd)

    with open("diff.txt", "r") as f:
        diff = f.read()
    os.remove("diff.txt")
    return diff


def getdiff(commitid):
    ''' get diff via git '''
    diffcmd = "git diff " + commitid + "~1" + " " + commitid 
    if os.path.isdir(kernel_path):
        old_dir = os.getcwd()
        os.chdir(kernel_path)

        diffcmd = diffcmd + " > diff.txt"

        # print(diffcmd)
        os.system(diffcmd)
        with open("diff.txt", "r") as f:
            d = f.read()

        os.remove("diff.txt")
        os.chdir(old_dir)

        if len(d) == 0:
            # print("getdiff: git diff error", commitid)
            return None
        return d
    return None